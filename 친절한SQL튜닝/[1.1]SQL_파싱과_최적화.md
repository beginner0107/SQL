# SQL 파싱과 최적화

## 1.1.1 구조적, 집합적, 선언적 질의 언어

- SQL은 "Structured Query Language"의 줄임말
- 구조적 질의 언어
- 원하는 결과집합을 ```구조적, 집합적```으로 선언하지만, 그 결과집합을 만드는 과정은 ```절차적```
- ```프로시저```가 필요
  - 그런 프로시저를 만들어 내는 DBMS 내부 엔진이 ```SQL 옵티마이저```
    1. 사용자가 SQL을 작성한다.
    2. 옵티마이저가 DBMS 내부에서 프로시저를 작성하고 컴파일해서 실행 가능한 상태로 만든다.
       - 이 과정을 ```SQL최적화```라고 한다.


### 예시
- 다음은 SQL을 사용하여 데이터베이스에서 고객의 주문을 조회하는 간단한 쿼리
```mysql
SELECT CustomerName, OrderDate, TotalAmount
FROM Orders
WHERE CustomerID = 12345;
```
- 이 쿼리는 "Orders" 테이블에서 "CustomerID"가 12345인 고객의 주문에 대한 정보를 가져옵니다. 
- 그러나 데이터베이스에서 이 쿼리를 실행하는 방법은 ```여러 가지```일 수 있습니다.
    1. 인덱스를 사용하였을 때 더 효율적인 경우
    2. 인덱스를 사용하지 않고 풀 스캔으로 검색했을 때 빠른 경우
- 일부 데이터베이스 시스템은 데이터를 가져오는 데 사용할 최적의 실행 계획을 결정하기 위해 통계 및 기타 정보를 고려할 수 있다.

### 요약
- 최적화 과정은 SQL 옵티마이저에 의해 수행된다.
- 옵티마이저는 쿼리를 분석하고 데이터베이스 구조를 고려하여 최적의 실행 계획을 결정
- 최적화된 실행 계획에 따라 데이터베이스 엔진이 작업을 수행하여 원하는 결과를 제공

## 1.1.2 SQL 최적화
- SQL을 실행하기 전 최적화 과정
  1. SQL 파싱
    - 사용자로부터 SQL을 전달받으면, SQL 파서(Parser)가 파싱을 진행
     - 파싱 트리 생성
       - SQL 문을 이루는 개별 구성요소를 분석해서 파싱 트리 생성
       - Syntax 체크 : 문법적 오류가 없는지 확인
       - Semantic 체크 : 의미상 오류가 없는지 확인
         - 예시1) 존재하지 않는 테이블 또는 컬럼을 사용했는지
         - 예시2) 사용한 오브젝트에 대한 권한이 있는지 확인
           - 뜻 : 데이터베이스 시스템이 SQL문을 실행하기 위해 필요한 데이터베이스 객체(테이블, 뷰, 프로시저)에 대한 권한을 확인하는 과정
           - 예시2에 대한 예시 : 사용자가 특정 테이블을 조회하는 SQL을 실행하려고 할 때, 데이터베이스 시스템은 해당 사용자에게 그 테이블에 대한 SELECT 권한이 있는지 확인
  2. SQL 최적화
     - 옵티마이저(Optimizer)의 역할
     - SQL 옵티마이저가 하는 일?
       - 미리 수집한 시스템 및 오브젝트 통계정보를 바탕으로 다양한 실행경로를 생성해서 비교한 후 가장 효율적인 하나늘 선택
       - 데이터베이스 성능을 결정하는 가장 핵심적인 엔진
  3. 로우 소스 생성
     - SQL 옵티마이저가 선택한 실행경로를 실제 실행 가능한 코드 또는 프로시저 형태로 포맷팅하는 단계
     - 로우 소스 생성기 (Row-Source Generator)가 그 역할을 맡음

### 예시
- 특정 회사의 직원에 대한 데이터를 가지고 있다고 가정
- 데이터베이스에는 'employees' 테이블이 있으며, 각 직원의 이름과 부서ID 등의 정보가 포함되어 있음
```mysql
SELECT first_name, last_name, department_id
FROM employees
WHERE department_id = 10;
```
1. SQL 파싱 트리 생성
```text
SELECT
  |
  |--COLUMNS
  |    |
  |    |--first_name
  |    |--last_name
  |
  |--FROM
  |    |
  |    |--employees
  |
  |--WHERE
       |
       |--department_id = 10

```
2. SQL 최적화
- SQL 옵티마이저가 다양한 실행 경로를 고려하여 최적의 실행 계획을 선택
- 이 경우, 'department_id'에 인덱스가 있을 경우 인덱스 스캔을 사용하는 것이 가장 효율적

3. 로우 소스 생성
- SQL 옵티마이저가 선택한 실행 계획을 실제 실행 가능한 코드 또는 프로시저 형태로 변환
```mysql
-- 프로시저 생성
CREATE PROCEDURE GetEmployeesByDepartment
AS
BEGIN
    -- employees 테이블에서 department_id가 10인 직원들을 선택하여 결과 반환
    SELECT first_name, last_name, department_id
    FROM employees
    WHERE department_id = 10;
END;
```
